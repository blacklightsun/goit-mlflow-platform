# apiVersion: argoproj.io/v1alpha1
# kind: Application
# metadata:
#   name: mlflow
#   namespace: argocd
#   finalizers:
#     - resources-finalizer.argocd.argoproj.io/background
# spec:
#   project: default
#   source:
#     repoURL: https://github.com/blacklightsun/goit-mlflow-platform.git
#     path: charts/mlflow
#     targetRevision: HEAD
#     helm:
#       valueFiles:
#         - ../../apps/mlflow/values.yaml
#   destination:
#     server: https://kubernetes.default.svc
#     namespace: mlflow
#   syncPolicy:
#     automated:
#       prune: true
#       selfHeal: true
#     syncOptions:
#       - CreateNamespace=true

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mlflow
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io/background
spec:
  project: default
  source:
    repoURL: https://community-charts.github.io/helm-charts
    chart: mlflow
    targetRevision: 0.7.19
    helm:
      values: |
        image:
          repository: python
          tag: "3.9-slim"
        
        service:
          type: ClusterIP
          port: 5000
        
        resources:
          requests:
            memory: 512Mi
            cpu: 100m
          limits:
            memory: 1Gi
            cpu: 500m
        
        # MLflow configuration
        backendStore:
          postgres:
            enabled: true
            host: postgres-postgresql.postgres.svc.cluster.local
            port: 5432
            database: mlflow
            username: mlflow
            password: mlflow123
        
        artifactStore:
          s3:
            enabled: true
            bucket: mlflow-artifacts
            endpoint: http://minio.minio.svc.cluster.local:9000
            accessKeyId: minioadmin
            secretAccessKey: minioadmin123
        
        extraEnvVars:
          - name: MLFLOW_S3_IGNORE_TLS
            value: "true"
          - name: AWS_ACCESS_KEY_ID
            value: "minioadmin"
          - name: AWS_SECRET_ACCESS_KEY
            value: "minioadmin123"
        
  destination:
    server: https://kubernetes.default.svc
    namespace: mlflow
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true